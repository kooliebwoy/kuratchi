# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Essential Commands

### Development and Testing
- `npm run build` - Compile TypeScript and build the package (required before using CLI)
- `npm run test:unit` - Run all unit tests via Vitest
- `npm test` - Alias for `npm run test:unit -- --run` (single test run)
- `npm run check` - Type check with SvelteKit sync and svelte-check
- `npm run prepack` - Build package for publishing (syncs, builds, and publints)

### Kuratchi CLI Usage Patterns
The CLI (`kuratchi`) requires a prior build to access dist files:

**Admin Database Management:**
```bash
# Create admin DB 
kuratchi admin create --account-id <id> --api-token <token> --workers-subdomain <sub>

# Migrate admin DB (uses filesystem migrations or JSON schema)
kuratchi admin migrate --token <admin_db_token> --workers-subdomain <sub>

# Destroy admin DB
kuratchi admin destroy --id <db_uuid> --account-id <id> --api-token <token>
```

**Migration Generation:**
```bash
# Generate admin migrations from schema
kuratchi admin generate-migrations --schema-file ./schema/admin.mjs --tag initial

# Generate org migrations from schema  
kuratchi org generate-migrations --schema-file ./schema/organization.mjs --tag initial
```

## Architecture Overview

**Core Concept:** Multi-organization MVP toolkit for rapid development with Cloudflare infrastructure.

### Main SDK Components

The `Kuratchi` class exposes five main service areas:
- **D1** - SQLite database provisioning and management
- **KV** - Key-value storage operations
- **R2** - Object storage operations  
- **DO** - Durable Objects management
- **Queues** - Message queue operations
- **Auth** - SvelteKit authentication integration

### Key Architectural Features

1. **Dual ORM System:**
   - Runtime ORM: Chainable query builder for D1 operations
   - JSON-schema ORM: Define schemas, generate migrations with automatic diffing

2. **Organization-Scoped Architecture:**
   - Admin DB manages organization metadata and database references
   - Each organization gets its own D1 database with isolated data
   - Auth is scoped per organization

3. **SvelteKit Integration:**
   - Handle-based auth with magic links and Google OAuth
   - Session management with HMAC integrity
   - Built-in routes for sign-in flows

4. **Migration Workflow:**
   - Automatic schema snapshotting to `meta/_schema.json`
   - Diffing between schema versions
   - Journal-based migration tracking in `meta/_journal.json`

## Project Structure

### Core Directories

- **`src/lib/`** - Main SDK modules organized by service:
  - `auth/` - Authentication services and SvelteKit integration
  - `d1/`, `kv/`, `r2/`, `do/`, `queues/` - Cloudflare service clients
  - `orm/` - Runtime query builder and JSON-schema migration system
  - `schema/` - TypeScript schema definitions and normalizers
  
- **`src/docs/`** - Comprehensive documentation for each feature
  - Individual markdown files for ORM, Auth, CLI, migrations, etc.
  - More detailed than README for specific implementation guidance

- **`bin/`** - CLI executable (`kuratchi.mjs`) with full D1 provisioning logic

- **`migrations-*/`** - Generated SQL migration bundles (not committed)
  - `migrations-admin/` - Admin database migrations
  - `migrations-org/` - Organization database migrations
  - Each contains `meta/_journal.json` and `<tag>.sql` files

- **`dist/`** - Compiled TypeScript output (generated by build)
  - Required by CLI for importing ORM and migration utilities

## Development Environment

### Project Type
This is a **SvelteKit package** that builds to `dist/` for distribution. The CLI depends on compiled files in `dist/`.

### Environment Variables
The system uses flexible environment variable naming (either form works):

**Cloudflare API Access:**
- `CF_ACCOUNT_ID` or `CLOUDFLARE_ACCOUNT_ID`
- `CF_API_TOKEN` or `CLOUDFLARE_API_TOKEN` 
- `CF_WORKERS_SUBDOMAIN` or `CLOUDFLARE_WORKERS_SUBDOMAIN`

**Admin Database:**
- `KURATCHI_ADMIN_DB_TOKEN` - Token for admin database operations
- `KURATCHI_ADMIN_DB_NAME` - Admin database name (default: kuratchi-admin)

**Auth Configuration:**
- `KURATCHI_AUTH_SECRET` - Required for session HMAC
- `ORIGIN` - App origin for OAuth/magic link URLs
- `RESEND_API_KEY`, `EMAIL_FROM` - Magic link email sending
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` - Google OAuth

### Database Architecture
- **Admin DB**: Central registry containing organization metadata and database references
- **Org DBs**: Individual D1 databases per organization with isolated user data
- The CLI can provision both admin and org databases via Cloudflare API

### Configuration Discovery
The CLI supports multiple config sources (in priority order):
1. Command line flags
2. Environment variables  
3. `kuratchi.config.mjs/js/json` files
4. `package.json` `kuratchi` section

## Testing

Tests are located in `src/tests/` and cover:
- End-to-end database operations
- ORM functionality (query builder, migrations, diffing)
- Auth flows and credential handling
- Service integration tests

Use `npm test` for CI runs or `npm run test:unit` for watch mode.
