# Authentication & Superadmin Setup

## Overview

The dashboard uses Kuratchi SDK's multi-tenant authentication system with two levels:

1. **Platform Admins** - Users in the admin database with special roles (superadmin, owner, etc.)
2. **Organization Members** - Users within individual organization databases

## Architecture

```
┌─────────────────────────────────────────┐
│         ADMIN DATABASE                  │
│  ┌──────────────────────────────────┐  │
│  │ users (platform admins)          │  │
│  │  - email                         │  │
│  │  - password_hash                 │  │
│  │  - role: 'superadmin' | 'owner'  │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │ organizations                    │  │
│  │ databases                        │  │
│  │ organizationUsers (email maps)   │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│    ORGANIZATION DATABASES (1 per org)   │
│  ┌──────────────────────────────────┐  │
│  │ users (org members)              │  │
│  │  - email                         │  │
│  │  - password_hash                 │  │
│  │  - role: 'owner' | 'member'      │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## Setup Flow

### 1. First Time: Create Superadmin

**Visit:** `/seed`

This creates the first platform admin with `role='superadmin'` in the ADMIN database.

```bash
# Set in your .env
KURATCHI_SEED_KEY=your-secure-seed-key
```

**What it does:**
- Creates a user directly in the admin database
- Sets `role='superadmin'`
- This user can access all organizations

### 2. Create Organizations

**Visit:** `/auth/signup`

This creates a new organization with its own database.

**What it does:**
1. Creates organization record in admin DB
2. Provisions a dedicated database for the org
3. Creates first user in the org database with `role='owner'`
4. Maps email → organizationId in admin DB for auth lookup

### 3. Sign In

**Visit:** `/auth/start`

Users can sign in with:
- Email/Password (credentials)
- Magic link (email)
- OAuth (Google, GitHub)

**Auth Flow:**
1. SDK looks up email in `organizationUsers` table (admin DB)
2. Gets the organizationId
3. Verifies password against user in that org's database
4. Creates session cookie with organizationId
5. If user has `role='superadmin'` in admin DB, superadmin plugin activates

## Superadmin Plugin

Enabled in `src/hooks.server.ts`:

```typescript
superadminPlugin() // Detects users with role='superadmin' in admin DB
```

**Detection Logic:**
- When a session is created, the plugin checks admin DB
- If `admin.users.role === 'superadmin'` for the logged-in email
- Sets `locals.kuratchi.superadmin.__isSuperadmin = true`

**Available Helpers:**
```typescript
// In any server endpoint or +page.server.ts
locals.kuratchi.superadmin.isSuperadmin() // → boolean
locals.kuratchi.superadmin.getActiveOrgId() // → current org or override
locals.kuratchi.superadmin.setOrganization(orgId) // Switch orgs
locals.kuratchi.superadmin.clearOrganization() // Back to user's org
```

## Routes

### Public Routes
- `/auth/start` - Sign in page
- `/auth/signup` - Create new organization
- `/seed` - Create first superadmin (should be protected in production!)

### Protected Routes
Add guards in `+page.server.ts`:

```typescript
// Require any auth
export const load = async ({ locals }) => {
  if (!locals.session) {
    throw redirect(302, '/auth/start');
  }
  return { user: locals.user };
};

// Require superadmin
export const load = async ({ locals }) => {
  if (!locals.kuratchi?.superadmin?.isSuperadmin()) {
    throw error(403, 'Superadmin access required');
  }
  return {};
};
```

## Environment Variables

```bash
# Auth
KURATCHI_AUTH_SECRET=your-long-random-secret-min-32-chars

# Admin Database
KURATCHI_ADMIN_DB_NAME=kuratchi-admin
KURATCHI_ADMIN_DB_TOKEN=...  # Generated by CLI

# Cloudflare
CLOUDFLARE_WORKERS_SUBDOMAIN=your-subdomain
CLOUDFLARE_ACCOUNT_ID=your-account-id
CLOUDFLARE_API_TOKEN=your-api-token
KURATCHI_GATEWAY_KEY=your-gateway-key

# Superadmin (for creating superadmins)
KURATCHI_SUPERADMIN_KEY=your-secure-seed-key

# Optional: Email (for magic links)
RESEND_API_KEY=your-resend-key
EMAIL_FROM="Your App <noreply@yourapp.com>"
```

## Security Notes

1. **Remove /superadmin/seed in production** - Or add proper authentication
2. **KURATCHI_SUPERADMIN_KEY** - Use a strong random value, validated by SDK
3. **KURATCHI_AUTH_SECRET** - Min 32 characters, keep secret
4. **Superadmin access** - Very powerful, limit who gets this role

## User Types Summary

| Type | Location | Role | Can Do |
|------|----------|------|--------|
| **Superadmin** | Admin DB | `superadmin` | Access all orgs, platform management |
| **Org Owner** | Org DB | `owner` | Manage their organization |
| **Org Member** | Org DB | `member` | Access their organization |
