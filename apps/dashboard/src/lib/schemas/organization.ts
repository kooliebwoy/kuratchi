import type { SchemaDsl } from 'kuratchi-sdk/database';

export const organizationSchema: SchemaDsl = {
  name: 'organization',
  version: 13,
  mixins: {
    timestamps: {
      updated_at: 'text default now',
      created_at: 'text default now',
      deleted_at: 'text'
    }
  },
  tables: {
    users: {
      id: 'text primary key not null',
      name: 'text',
      firstName: 'text',
      lastName: 'text',
      phone: 'text',
      email: 'text not null unique',
      emailVerified: 'timestamp_ms',
      image: 'text',
      status: 'boolean', // true (active) | false (suspended) - use invite_token to detect invited
      role: 'text', // More flexible for custom roles
      password_hash: 'text',
      accessAttempts: 'integer',
      tenantId: 'text',
      organization: 'text',
      invite_token: 'text', // If set, user is invited (hasn't accepted yet)
      invite_expires_at: 'timestamp_ms',
      invited_by: 'text',
      '...timestamps': true,
    },
    session: {
      sessionToken: 'text primary key not null',
      userId: 'text not null -> users.id cascade',
      expires: 'timestamp_ms not null',
      '...timestamps': true,
    },
    passwordResetTokens: {
      id: 'text primary key',
      token: 'text not null',
      email: 'text not null',
      expires: 'timestamp_ms not null',
      '...timestamps': true,
    },
    emailVerificationToken: {
      id: 'text primary key',
      token: 'text not null',
      email: 'text not null',
      userId: 'text not null',
      expires: 'timestamp_ms not null',
      '...timestamps': true,
    },
    magicLinkTokens: {
      id: 'text primary key',
      token: 'text not null',
      email: 'text not null',
      redirectTo: 'text',
      consumed_at: 'timestamp_ms',
      expires: 'timestamp_ms not null',
      '...timestamps': true,
    },
    activity: {
      id: 'text primary key',
      userId: 'text',
      action: 'text not null',
      data: 'json default (json_object())',
      status: 'boolean',
      isAdminAction: 'boolean default false',
      ip: 'text',
      userAgent: 'text',
      '...timestamps': true,
    },
    roles: {
      id: 'text primary key',
      name: 'text not null',
      description: 'text',
      permissions: 'json',
      '...timestamps': true,
    },
    oauthAccounts: {
      id: 'text primary key',
      userId: 'text -> users.id cascade',
      provider: 'text not null',
      providerAccountId: 'text not null',
      access_token: 'text',
      refresh_token: 'text',
      id_token: 'text',
      expires_at: 'timestamp_ms',
      scope: 'text',
      token_type: 'text',
      '...timestamps': true,
    },
    sites: {
      id: 'text primary key not null',
      name: 'text',
      subdomain: 'text',
      description: 'text',
      status: 'boolean',
      domain: 'text', // Site domain (e.g., subdomain.kuratchi.site)
      environment: 'enum(production,preview)',
      theme: 'text',
      databaseId: 'text',
      dbuuid: 'text',
      workerName: 'text',
      r2BucketName: 'text',
      r2Binding: 'text',
      r2StorageDomain: 'text', // Custom storage domain (e.g., subdomain.kuratchi.cloud)
      metadata: 'json',
      analytics_token: 'text', // Cloudflare Web Analytics site tag
      '...timestamps': true,
    },
    siteCustomDomains: {
      id: 'text primary key not null',
      siteId: 'text -> sites.id cascade',
      domain: 'text not null',
      domainId: 'text',
      verified: 'boolean default false',
      cnameTarget: 'text',
      verificationToken: 'text',
      cloudflareStatus: 'text',
      cloudflareHostnameId: 'text',
      sslStatus: 'text',
      '...timestamps': true,
    },
    userSites: {
      userId: 'text -> users.id cascade',
      siteId: 'text -> sites.id cascade',
      '...timestamps': true,
    },
    email_logs: {
      id: 'text primary key not null',
      recipient: 'text not null default ""',
      sender: 'text not null default ""',
      subject: 'text not null default ""',
      emailType: 'text',
      status: 'enum(sent,delivered,bounced,complained,rejected,failed,pending) default pending',
      sesMessageId: 'text',
      error: 'text',
      userId: 'text -> users.id',
      metadata: 'json',
      sentAt: 'text',
      deliveredAt: 'text',
      deliveryDelay: 'integer',
      openedAt: 'text',
      openCount: 'integer default 0',
      userAgent: 'text',
      clickedAt: 'text',
      clickCount: 'integer default 0',
      lastClickedLink: 'text',
      bouncedAt: 'text',
      bounceType: 'text',
      bounceSubType: 'text',
      complainedAt: 'text',
      complaintFeedbackType: 'text',
      rejectedAt: 'text',
      rejectReason: 'text',
      deliveryDelayed: 'boolean default false',
      deliveryDelayType: 'text',
      '...timestamps': true,
    },
    broadcasts: {
      id: 'text primary key not null',
      name: 'text not null default ""',
      subject: 'text not null default ""',
      html: 'text not null default ""',
      segmentId: 'text not null',
      segmentName: 'text default ""',
      status: 'enum(draft,sending,sent,failed) default draft',
      scheduledAt: 'text',
      sentAt: 'text',
      totalRecipients: 'integer default 0',
      sentCount: 'integer default 0',
      deliveredCount: 'integer default 0',
      openedCount: 'integer default 0',
      clickedCount: 'integer default 0',
      bouncedCount: 'integer default 0',
      '...timestamps': true,
    },
    // Organization-level forms (reusable across sites)
    forms: {
      id: 'text primary key not null',
      name: 'text not null',
      description: 'text',
      fields: 'json default (json_array())',
      settings: 'json default (json_object())',
      styling: 'json default (json_object())',
      status: 'boolean default true',
      '...timestamps': true,
    },
    // Junction table: which forms are attached to which sites
    formSites: {
      id: 'text primary key not null',
      formId: 'text not null -> forms.id cascade',
      siteId: 'text not null -> sites.id cascade',
      // Site-specific overrides (optional)
      overrides: 'json default (json_object())',
      status: 'boolean default true',
      '...timestamps': true,
    },
    // Leads from form submissions (with site attribution)
    leads: {
      id: 'text primary key not null',
      formId: 'text not null -> forms.id cascade',
      siteId: 'text -> sites.id',
      data: 'json default (json_object())',
      source: 'text',
      ipAddress: 'text',
      userAgent: 'text',
      status: 'enum(new,contacted,qualified,converted,archived) default new',
      notes: 'text',
      '...timestamps': true,
    },
    // Newsletter Segments
    newsletter_segments: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      name: 'text not null',
      description: 'text',
      subscriberCount: 'integer default 0',
      '...timestamps': true,
    },
    // Newsletter Contacts
    newsletter_contacts: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      email: 'text not null',
      firstName: 'text',
      lastName: 'text',
      unsubscribed: 'integer default 0',
      unsubscribedAt: 'text',
      metadata: 'json',
      '...timestamps': true,
    },
    // Newsletter Segment-Contact relationship
    newsletter_segment_contacts: {
      segmentId: 'text not null',
      contactId: 'text not null',
      added_at: 'text not null',
    },
    // Newsletter Templates
    newsletter_templates: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      name: 'text not null',
      subject: 'text not null',
      html: 'text not null',
      text: 'text',
      previewText: 'text',
      '...timestamps': true,
    },
    // Newsletter Broadcasts
    newsletter_broadcasts: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      segmentId: 'text not null',
      name: 'text not null',
      subject: 'text not null',
      html: 'text',
      text: 'text',
      previewText: 'text',
      status: 'text not null default draft',
      scheduledAt: 'text',
      sentAt: 'text',
      recipientCount: 'integer default 0',
      successCount: 'integer default 0',
      failureCount: 'integer default 0',
      '...timestamps': true,
    },
    // Newsletter Campaigns (Drip)
    newsletter_campaigns: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      segmentId: 'text not null',
      name: 'text not null',
      description: 'text',
      status: 'text not null default draft',
      startAt: 'text',
      lastLaunchAt: 'text',
      contactsTargeted: 'integer default 0',
      totalScheduled: 'integer default 0',
      '...timestamps': true,
    },
    // Newsletter Campaign Steps
    newsletter_campaign_steps: {
      id: 'text primary key not null',
      campaignId: 'text not null',
      organizationId: 'text not null',
      stepOrder: 'integer not null',
      label: 'text not null',
      subject: 'text not null',
      html: 'text',
      text: 'text',
      previewText: 'text',
      scheduleMode: 'text not null',
      sendAt: 'text',
      delayMinutes: 'integer default 0',
      status: 'text not null default pending',
      monitorEvent: 'text',
      successStepId: 'text',
      fallbackStepId: 'text',
      evaluateAfterMinutes: 'integer',
      '...timestamps': true,
    },
    // Newsletter Sent Emails (Tracking)
    newsletter_sent_emails: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      contactId: 'text not null',
      email: 'text not null',
      type: 'text not null',
      broadcastId: 'text',
      campaignId: 'text',
      campaignStepId: 'text',
      subject: 'text not null',
      sesMessageId: 'text',
      status: 'text not null default pending',
      scheduledAt: 'text',
      sentAt: 'text',
      deliveredAt: 'text',
      openedAt: 'text',
      clickedAt: 'text',
      failedAt: 'text',
      error: 'text',
      metadata: 'json',
      '...timestamps': true,
    },
    // Newsletter Branch Checks (for campaign conditional logic)
    newsletter_branch_checks: {
      id: 'text primary key not null',
      organizationId: 'text not null',
      campaignId: 'text not null',
      stepId: 'text not null',
      contactId: 'text not null',
      sentEmailId: 'text not null',
      monitorEvent: 'text not null',
      successStepId: 'text',
      fallbackStepId: 'text',
      evaluateAt: 'text not null',
      baseTime: 'text not null',
      processed: 'integer default 0',
      processedAt: 'text',
      '...timestamps': true,
    },
    // =========== OEM CATALOG TABLES ===========
    catalogOems: {
      id: 'text primary key not null',
      name: 'text not null',
      logo_url: 'text',
      website_url: 'text',
      description: 'text',
      '...timestamps': true,
    },
    catalogVehicles: {
      id: 'text primary key not null',
      oem_id: 'text not null -> catalogOems.id cascade',
      oem_name: 'text not null',
      model_name: 'text not null',
      model_year: 'integer',
      category: 'text default other',
      msrp: 'integer',
      currency: 'text default USD',
      source_url: 'text',
      thumbnail_url: 'text',        // Original scraped URL
      cdn_thumbnail_url: 'text',    // R2 CDN URL (preferred)
      images: 'json default (json_array())',           // Original image URLs
      cdn_images: 'json default (json_array())',       // R2 CDN image URLs
      specifications: 'json default (json_object())',
      features: 'json default (json_array())',
      description: 'text',
      status: 'text default draft',
      '...timestamps': true,
    },
    catalogVehicleImages: {
      id: 'text primary key not null',
      vehicle_id: 'text not null -> catalogVehicles.id cascade',
      url: 'text not null',         // Original source URL
      cdn_url: 'text',              // R2 CDN URL (preferred)
      alt_text: 'text',
      is_primary: 'boolean default 0',
      sort_order: 'integer default 0',
      image_source: 'text default stock',  // 'stock' or 'custom'
      '...timestamps': true,
    },
    catalogCategories: {
      id: 'text primary key not null',
      name: 'text not null',
      slug: 'text not null unique',
      description: 'text',
      color: 'text default #6b7280',
      icon: 'text default tag',
      parent_id: 'text',
      sort_order: 'integer default 0',
      '...timestamps': true,
    },
    catalogSpecTemplates: {
      id: 'text primary key not null',
      category: 'text',
      name: 'text not null',
      label: 'text not null',
      unit: 'text',
      input_type: 'text default text',
      options: 'json',
      sort_order: 'integer default 0',
      '...timestamps': true,
    },
  },
  indexes: {
    // Newsletter indexes for performance
    newsletter_segments: {
      idx_newsletter_segments_org: { columns: ['organizationId'] },
    },
    newsletter_contacts: {
      idx_newsletter_contacts_org: { columns: ['organizationId'] },
      idx_newsletter_contacts_email: { columns: ['organizationId', 'email'] },
      idx_newsletter_contacts_org_email: { columns: ['organizationId', 'email'], unique: true },
    },
    newsletter_segment_contacts: {
      idx_newsletter_segment_contacts_segment: { columns: ['segmentId'] },
      idx_newsletter_segment_contacts_contact: { columns: ['contactId'] },
      idx_newsletter_segment_contacts_pk: { columns: ['segmentId', 'contactId'], unique: true },
    },
    newsletter_templates: {
      idx_newsletter_templates_org: { columns: ['organizationId'] },
    },
    newsletter_broadcasts: {
      idx_newsletter_broadcasts_org: { columns: ['organizationId'] },
      idx_newsletter_broadcasts_segment: { columns: ['segmentId'] },
      idx_newsletter_broadcasts_status: { columns: ['status'] },
    },
    newsletter_campaigns: {
      idx_newsletter_campaigns_org: { columns: ['organizationId'] },
      idx_newsletter_campaigns_segment: { columns: ['segmentId'] },
      idx_newsletter_campaigns_status: { columns: ['status'] },
    },
    newsletter_campaign_steps: {
      idx_newsletter_campaign_steps_campaign: { columns: ['campaignId'] },
      idx_newsletter_campaign_steps_org: { columns: ['organizationId'] },
    },
    newsletter_sent_emails: {
      idx_newsletter_sent_emails_org: { columns: ['organizationId'] },
      idx_newsletter_sent_emails_contact: { columns: ['contactId'] },
      idx_newsletter_sent_emails_broadcast: { columns: ['broadcastId'] },
      idx_newsletter_sent_emails_campaign: { columns: ['campaignId'] },
      idx_newsletter_sent_emails_status: { columns: ['status'] },
      idx_newsletter_sent_emails_ses: { columns: ['sesMessageId'] },
    },
    newsletter_branch_checks: {
      idx_newsletter_branch_checks_campaign: { columns: ['campaignId'] },
      idx_newsletter_branch_checks_contact: { columns: ['contactId'] },
      idx_newsletter_branch_checks_evaluate: { columns: ['evaluateAt', 'processed'] },
    },
    // Catalog indexes
    catalogVehicles: {
      idx_catalog_vehicles_oem: { columns: ['oem_id'] },
      idx_catalog_vehicles_category: { columns: ['category'] },
      idx_catalog_vehicles_status: { columns: ['status'] },
    },
    catalogVehicleImages: {
      idx_catalog_vehicle_images_vehicle: { columns: ['vehicle_id'] },
    },
    catalogCategories: {
      idx_catalog_categories_parent: { columns: ['parent_id'] },
    },
    catalogSpecTemplates: {
      idx_catalog_spec_templates_category: { columns: ['category'] },
    },
  },
} as const;
