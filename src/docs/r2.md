# R2 Guide

This guide covers provisioning Cloudflare R2 buckets with Kuratchi and using them at runtime via a minimal Worker HTTP API.

- R2 code: `src/lib/r2/`
  - Worker template: `src/lib/r2/worker-template.ts`
  - Internal client: `src/lib/r2/internal-http-client.ts`
  - SDK class: `src/lib/r2/kuratchi-r2.ts`

## Prerequisites

- Cloudflare account with R2 enabled
- API Token with R2 + Workers permissions
- Workers subdomain, e.g. `example.workers.dev`

## Instantiate Kuratchi

```ts
import { Kuratchi } from 'kuratchi';

const kuratchi = new Kuratchi({
  apiToken: process.env.CLOUDFLARE_API_TOKEN!,
  accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
  workersSubdomain: process.env.CLOUDFLARE_WORKERS_SUBDOMAIN!,
});
```

## Create a bucket

```ts
const { bucket, apiToken } = await kuratchi.r2.createBucket('acme-r2');
```

- Returns the created R2 bucket and an API token injected as a Worker secret.
- A Worker named after the bucket is deployed and bound to the bucket as `env.R2`.
- Subdomain is enabled; Kuratchi waits until the endpoint is responsive.

## Connect to an existing bucket

```ts
const b = kuratchi.r2.bucket({
  bucketName: 'acme-r2',
  apiToken, // store and reuse the token you received at creation time
});
```

Exposed methods on `b`:
- `get(key, { json? })` â€” returns object text/JSON plus size, etag, http/custom metadata
- `put(key, value, { httpMetadata?, customMetadata?, md5? })`
- `delete(key)`
- `list({ prefix?, limit?, cursor?, delimiter? })`

### Examples

```ts
// put string
await b.put('docs/readme.txt', 'hello');

// put JSON (auto sets contentType: application/json)
await b.put('data/user-1.json', { id: 1, email: 'a@acme.com' });

// put with metadata
await b.put('image.png', '<binary-or-base64>', {
  httpMetadata: { contentType: 'image/png' },
  customMetadata: { source: 'upload' }
});

// get JSON
const user = await b.get<{ id: number; email: string }>('data/user-1.json', { json: true });

// list with prefix and delimiter (simulate folder listing)
const page1 = await b.list({ prefix: 'docs/', delimiter: '/' });
if (page1.truncated && page1.cursor) {
  const page2 = await b.list({ prefix: 'docs/', delimiter: '/', cursor: page1.cursor });
}

// delete
await b.delete('docs/readme.txt');
```

## Deleting a bucket

```ts
await kuratchi.r2.deleteBucket('acme-r2');
```

## Notes
- Keep API tokens secret; do not ship them to browsers.
- Worker endpoint: `https://<bucketName>.<workersSubdomain>`.
- Minimal HTTP API secured with `API_KEY`. Adjust CORS in production if needed.
