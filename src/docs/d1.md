# D1 Guide

This guide covers provisioning Cloudflare D1 databases with Kuratchi and using them at runtime.

- Kuratchi D1 class: `src/lib/d1/kuratchi-d1.ts`
- Runtime ORM: `src/lib/orm/kuratchi-orm.ts`
- Vite migration loader: `src/lib/orm/loader.ts`

## Prerequisites

- Cloudflare account with D1 enabled
- API Token with D1 + Workers permissions
- Your Workers subdomain, e.g. `example.workers.dev`

## Instantiate Kuratchi

```ts
import { Kuratchi } from 'kuratchi';

const kuratchi = new Kuratchi({
  apiToken: process.env.CLOUDFLARE_API_TOKEN!,
  accountId: process.env.CLOUDFLARE_ACCOUNT_ID!,
  workersSubdomain: process.env.CLOUDFLARE_WORKERS_SUBDOMAIN!,
});
```

## Create a database

```ts
const { database, apiToken } = await kuratchi.d1.createDatabase('acme-org', {
  // Optional: location hint for primary
  // location: 'weur' satisfies PrimaryLocationHint
});
```

- Returns the created D1 database (with Worker bound) and an API token injected as a Worker secret.
- Kuratchi waits briefly for the Worker endpoint to become responsive.

## Connect to an existing database

```ts
const db = kuratchi.d1.database({
  databaseName: database.name,
  apiToken, // the token returned above or previously stored
});
```

Exposed methods on `db`:
- `query<T>(sql, params?)` – raw SQL.
- `drizzleProxy()` – Drizzle-compatible proxy if you prefer Drizzle.
- `migrate(dirName)` – apply migrations at runtime using Vite’s `import.meta.glob` loader.
- `client({ schema })` – returns a typed property-based client for `'admin'` or `'organization'`, or a dynamic client from a JSON schema.

## Apply migrations

There are two parts: generating bundles (CLI) and applying them (runtime).

1) Generate migration bundles via CLI (admin/org):
```sh
# Admin initial bundle
kuratchi admin generate-migrations \
  --schema-json-file ./src/lib/schema-json/admin.json \
  --tag initial

# Organization bundles using the alias (snapshotting enabled)
kuratchi org generate-migrations \
  --schema-json-file ./src/lib/schema-json/organization.json \
  --tag initial
```
- The generator writes to `./migrations-<dir>/` and maintains `meta/_journal.json`.
- Automatic schema snapshotting stores the latest schema at `meta/_schema.json` and diffs from it next run.

2) Apply at runtime (Vite/SvelteKit):
```ts
await db.migrate('org'); // looks for /migrations-org
```
- The loader expects files under `/migrations-<dir>` with `<tag>.sql` and a `meta/_journal.json`.
- Requires Vite (SvelteKit) for `import.meta.glob`.

## Typed clients

You can get typed, property-based clients for the built-in schemas:

```ts
// top-level
const org = kuratchi.d1.client({ databaseName, apiToken }, { schema: 'organization' });
const admin = kuratchi.d1.client({ databaseName, apiToken }, { schema: 'admin' });

// or from a db handle
const org2 = db.client({ schema: 'organization' });
```

Example operations:
```ts
await org.users.insert({ id: 'u1', email: 'a@acme.com' });
const user = await org.users.where({ email: { like: '%@acme.com' } }).first();
await org.session.delete({ userId: 'u1' });
```

You can also create a dynamic client from a JSON schema (internal/testing):
```ts
// In this source repo only, you can import the helper directly:
import { createClientFromJsonSchema } from '../lib/orm/kuratchi-orm';
const dyn = createClientFromJsonSchema((sql, params) => db.query(sql, params), mySchemaJson);
```
Note: this is not currently part of the public package export. Prefer the typed clients
(`schema: 'admin' | 'organization'`) for application code.

## Deleting a database

```ts
await kuratchi.d1.deleteDatabase('<database-uuid>');
```

## Notes
- Keep API tokens secret. Do not expose in browser bundles.
- Use `bookmark` for read consistency on `kuratchi.d1.database({ bookmark })` when necessary.
- For Admin DB migration apply from a CI/CLI, see `src/docs/migrations.md`.
